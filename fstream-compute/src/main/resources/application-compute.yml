---

#
# Copyright (c) 2014 fStream. All Rights Reserved.
# 
# Project and contact information: https://bitbucket.org/fstream/fstream
# 
# Unauthorized copying of this file, via any medium is strictly prohibited.
# Proprietary and confidential.
#

compute:
	alerts:
	
	   # -----------------------------------------------
	   # Definitions
	   # -----------------------------------------------
	      
	   # Named segmentation by instruments
	   - definition: |
	     CREATE CONTEXT 
	        SegmentedBySymbol
	     PARTITION BY 
	        symbol 
	     FROM
	        Rate
	        
	   # -----------------------------------------------
	   # Alerts
	   # -----------------------------------------------
	        
	   # Relative tick threshold
	   # Tick-to-tick percentage is greater than 1%.
	   - definition: |
	     CONTEXT SegmentedBySymbol
	     SELECT
	        ask / prior(1, ask) AS askPercentChange
	     FROM
	        Rate
	     WHERE
	        ask / prior(1, ask) > 1.01
	     
	   # Simple stats
	   # Used to trigger at least one event every 5s for testing.
	   - definition: |
	     CONTEXT SegmentedBySymbol
	     SELECT
	         symbol,
	         COUNT(ask) AS count,
	         AVG(ask)   AS avgAsk,
	         AVG(bid)   AS avgBid,
	         MIN(ask)   AS minAsk,
	         MIN(bid)   AS minBid,
	         MAX(ask)   AS maxAsk,
	         MAX(bid)   AS maxBid
	     FROM
	         Rate.win:time_batch(5 sec)
	         
	   # Flat pricing
	   # Coded to fire many times. Final implementation would count < 1 every 60 secs.
	   - definition: |
	     CONTEXT SegmentedBySymbol
	     SELECT
	         symbol, 
	         COUNT(*) AS eventCnt 
	     FROM
	         Rate.win:time(10 sec)
	     GROUP BY 
	         symbol
	     HAVING
	         COUNT(*) < 5
	         
	   # -----------------------------------------------
	   # Metrics
	   # -----------------------------------------------